/*! grunt-pluralsight 08-08-2017 */

function protect(e){User.schema.path(e).set(function(t){return this.isProtected&&this.get(e)?this.get(e):t})}var Types=(keystone=require("keystone")).Field.Types;(Enquiry=new keystone.List("Enquiry",{nocreate:!0})).add({name:{type:Types.Name,required:!0},email:{type:Types.Email,required:!0},phone:{type:String},enquiryType:{type:Types.Select,options:[{value:"message",label:"Just leaving a message"},{value:"question",label:"I've got a question"},{value:"other",label:"Something else..."}],required:!0},message:{type:Types.Textarea,required:!0}}),Enquiry.track=!0,Enquiry.defaultSort="-createdAt",Enquiry.defaultColumns="name, email, enquiryType, createdAt",Enquiry.register();var Types=(keystone=require("keystone")).Field.Types;(Gallery=new keystone.List("Gallery",{autokey:{from:"name",path:"key",unique:!0},plural:"Albums",singular:"Album"})).add({name:{type:String,required:!0},publishedDate:{type:Types.Date,default:Date.now},images:{type:Types.CloudinaryImages}}),Gallery.track=!0,Gallery.defaultSort="name",Gallery.defaultColumns="name, publishedDate",Gallery.register();var Types=(keystone=require("keystone")).Field.Types;(Post=new keystone.List("Post",{autokey:{from:"name",path:"key",unique:!0}})).add({name:{type:String,required:!0},state:{type:Types.Select,options:"draft, published, archived",default:"draft",index:!0},author:{type:Types.Relationship,ref:"User",index:!0},publishedDate:{type:Types.Date,index:!0},image:{type:Types.CloudinaryImage},content:{brief:{type:Types.Html,wysiwyg:!0,height:150},extended:{type:Types.Html,wysiwyg:!0,height:400}},categories:{type:Types.Relationship,ref:"PostCategory",many:!0}}),Post.schema.virtual("content.full").get(function(){return this.content.extended||this.content.brief}),Post.relationship({path:"comments",ref:"PostComment",refPath:"post"}),Post.track=!0,Post.defaultColumns="name, state|20%, author|20%, publishedDate|20%",Post.register();var Types=(keystone=require("keystone")).Field.Types;(PostCategory=new keystone.List("PostCategory",{autokey:{from:"name",path:"key",unique:!0},label:"Categories"})).add({name:{type:String,required:!0}}),PostCategory.relationship({ref:"Post",refPath:"categories"}),PostCategory.track=!0,PostCategory.register();var Types=(keystone=require("keystone")).Field.Types;(PostComment=new keystone.List("PostComment",{label:"Comments"})).add({author:{type:Types.Relationship,initial:!0,ref:"User",index:!0},post:{type:Types.Relationship,initial:!0,ref:"Post",index:!0},commentState:{type:Types.Select,options:["published","draft","archived"],default:"published",index:!0},publishedOn:{type:Types.Date,default:Date.now,noedit:!0,index:!0}}),PostComment.add("Content",{content:{type:Types.Html,wysiwyg:!0,height:300}}),PostComment.schema.pre("save",function(e){this.wasNew=this.isNew,!this.isModified("publishedOn")&&this.isModified("commentState")&&"published"===this.commentState&&(this.publishedOn=new Date),e()}),PostComment.schema.post("save",function(){this.wasNew&&this.author&&keystone.list("User").model.findById(this.author).exec(function(e,t){t&&t.wasActive().save()})}),PostComment.track=!0,PostComment.defaultColumns="author, post, publishedOn, commentState",PostComment.register();var Types=(keystone=require("keystone")).Field.Types,Thing=new keystone.List("Thing",{label:"All Fields",singular:"Thing",plural:"Things",autokey:{from:"name",path:"autokey",unique:!0}});Thing.add("Simple Fields",{name:{type:String},requiredString:{type:String,required:!0,initial:!0,note:"This field is required."},defaultString:{type:String,default:"Default Value"},shortString:{type:String,width:"small"},mediumString:{type:String,width:"medium"},longString:{type:String,width:"large"},textarea:{type:Types.Textarea,initial:!0},key:{type:Types.Key},email:{type:Types.Email},url:{type:Types.Url},number:{type:Types.Number},money:{type:Types.Money},checkbox:{type:Boolean,initial:!0},date:{type:Types.Date},dateTime:{type:Date},html:{type:Types.Html}},"Complex Fields",{select:{type:Types.Select,options:"first, second, third",initial:!0},indentedCheckbox:{type:Boolean,initial:!0,indent:!0,note:"This checkbox is indented"},customSelect:{type:Types.Select,options:[{label:"Option 1",value:"one"},{label:"Option 2",value:"two"},{label:"Option 3",value:"three"}]},numericSelect:{type:Types.Select,numeric:!0,options:[{label:"Number 1",value:1},{label:"Number 2",value:2},{label:"Number 3",value:3}]},splitName:{type:Types.Name,initial:!0},password:{type:Types.Password,initial:!0},cloudinaryImage:{type:Types.CloudinaryImage},cloudinaryImages:{type:Types.CloudinaryImages},location:{type:Types.Location},wysiwygHtml:{type:Types.Html,wysiwyg:!0},shortWysiwygField:{type:Types.Html,wysiwyg:!0,height:100}},"Dependent Fields",{otherSelect:{type:Types.Select,options:[{label:"Pre-defined Value",value:"predefined"},{label:"Other Value",value:"other"}]},otherValue:{type:String,dependsOn:{otherSelect:"other"}}},"Relationships",{user:{type:Types.Relationship,ref:"User",initial:!0},users:{type:Types.Relationship,ref:"User",many:!0},nested:{posts:{type:Types.Relationship,ref:"Post"}}},"Uneditable Fields",{uneditableString:{type:String,noedit:!0,default:"Not editable"},uneditableCheckbox:{type:Boolean,noedit:!0,default:!0},uneditableDate:{type:Types.Date,noedit:!0,default:Date.now},uneditableSelect:{type:Types.Select,noedit:!0,options:"Sydney, New York, London, Paris, Hong Kong",default:"Sydney"},uneditableLocation:{type:Types.Location,noedit:!0,defaults:{street1:"283-285 Kent St",suburb:"Sydney",state:"NSW",postcode:"2000",country:"Australia"}}}),Thing.schema.virtual("otherSelectValue").get(function(){return"other"===this.otherSelect?this.otherValue:this.otherSelect}),Thing.track=!0,Thing.register();var Types=(keystone=require("keystone")).Field.Types;(User=new keystone.List("User",{nodelete:!0})).add({name:{type:Types.Name,required:!0,index:!0},email:{type:Types.Email,initial:!0,required:!0,index:!0,unique:!0},phone:{type:String,width:"short"},photo:{type:Types.CloudinaryImage,collapse:!0},password:{type:Types.Password,initial:!0,required:!1}},"Permissions",{isProtected:{type:Boolean,noedit:!0}}),User.schema.virtual("canAccessKeystone").get(function(){return!0}),User.relationship({ref:"Post",path:"posts",refPath:"author"}),User.schema.methods.wasActive=function(){return this.lastActiveOn=new Date,this},["name.first","name.last","email","isProtected"].forEach(protect),User.schema.path("password").set(function(e){return this.isProtected?"$2a$10$fMeQ6uNsJhJZnY/6soWfc.Mq8T3MwANJK52LQCK2jzw/NjE.JBHV2":(this.__password_needs_hashing=!0,e)}),User.track=!0,User.defaultColumns="name, email, phone, photo",User.register();var keystone=require("keystone"),csv=require("csv"),User=keystone.list("User");exports=module.exports=function(e,t){User.model.find(function(e,o){if(e)throw e;var s=o.map(function(e){return{firstName:e.name.first,lastName:e.name.last,email:e.email}});csv.stringify(s,function(o,s){if(o)throw e;t.set({"Content-Disposition":'attachment; filename="users.csv"'}),t.send(s)})})};var keystone=require("keystone"),middleware=require("./middleware"),importRoutes=keystone.importer(__dirname);keystone.pre("routes",function(e,t,o){t.locals.navLinks=[{label:"Home",key:"home",href:"/"},{label:"Blog",key:"blog",href:"/blog"},{label:"Gallery",key:"gallery",href:"/gallery"},{label:"Contact",key:"contact",href:"/contact"}],t.locals.user=e.user,o()}),keystone.pre("render",middleware.theme),keystone.pre("render",middleware.flashMessages),keystone.set("404",function(e,t,o){middleware.theme(e,t,o),t.status(404).render("errors/404")});var routes={download:importRoutes("./download"),views:importRoutes("./views")};exports=module.exports=function(e){e.get("/",routes.views.index),e.get("/blog/:category?",routes.views.blog),e.all("/blog/post/:post",routes.views.post),e.get("/gallery",routes.views.gallery),e.all("/contact",routes.views.contact),e.get("/download/users",routes.download.users)};var _=require("lodash");exports.theme=function(e,t,o){e.query.theme&&(e.session.theme=e.query.theme),t.locals.themes=["Bootstrap","Cerulean","Cosmo","Cyborg","Darkly","Flatly","Journal","Lumen","Paper","Readable","Sandstone","Simplex","Slate","Spacelab","Superhero","United","Yeti"],t.locals.currentTheme=e.session.theme||"Bootstrap",o()},exports.flashMessages=function(e,t,o){var s={info:e.flash("info"),success:e.flash("success"),warning:e.flash("warning"),error:e.flash("error")};t.locals.messages=!!_.some(s,function(e){return e.length})&&s,o()};var keystone=require("keystone"),async=require("async"),Post=keystone.list("Post"),PostCategory=keystone.list("PostCategory");exports=module.exports=function(e,t){var o=new keystone.View(e,t),s=t.locals;s.section="blog",s.filters={category:e.params.category},s.posts=[],s.categories=[],o.on("init",function(e){PostCategory.model.find().sort("name").exec(function(t,o){if(t||!o.length)return e(t);s.categories=o,async.each(s.categories,function(e,t){keystone.list("Post").model.count().where("state","published").where("categories").in([e.id]).exec(function(o,s){e.postCount=s,t(o)})},function(t){e(t)})})}),o.on("init",function(t){e.params.category?PostCategory.model.findOne({key:s.filters.category}).exec(function(e,o){s.category=o,t(e)}):t()}),o.on("init",function(t){var o=Post.paginate({page:e.query.page||1,perPage:10,maxPages:10}).where("state","published").sort("-publishedDate").populate("author categories");s.category&&o.where("categories").in([s.category]),o.exec(function(e,o){s.posts=o,t(e)})}),o.render("blog")};var Enquiry=(keystone=require("keystone")).list("Enquiry");exports=module.exports=function(e,t){var o=new keystone.View(e,t),s=t.locals;s.section="contact",s.enquiryTypes=Enquiry.fields.enquiryType.ops,s.formData=e.body||{},s.validationErrors={},s.enquirySubmitted=!1,o.on("post",{action:"contact"},function(t){(new Enquiry.model).getUpdateHandler(e).process(e.body,{flashErrors:!0},function(e){e?s.validationErrors=e.errors:s.enquirySubmitted=!0,t()})}),o.render("contact",{section:"contact"})};var Gallery=(keystone=require("keystone")).list("Gallery");exports=module.exports=function(e,t){var o=new keystone.View(e,t);t.locals.section="gallery",o.query("galleries",Gallery.model.find().sort("sortOrder")),o.render("gallery")};var keystone=require("keystone");exports=module.exports=function(e,t){new keystone.View(e,t).render("index",{section:"home"})};var Post=(keystone=require("keystone")).list("Post"),PostComment=keystone.list("PostComment");exports=module.exports=function(e,t){var o=new keystone.View(e,t),s=t.locals;s.section="blog",s.filters={post:e.params.post},o.on("init",function(e){Post.model.findOne({state:"published",key:s.filters.post}).populate("author categories").exec(function(t,o){s.post=o,e(t)})}),o.on("init",function(e){Post.model.find().where("state","published").sort("-publishedDate").populate("author").limit(4).exec(function(t,o){s.posts=o,e(t)})}),o.on("init",function(e){PostComment.model.find().where("post",s.post).where("commentState","published").where("author").ne(null).populate("author","name photo").sort("-publishedOn").exec(function(o,n){return o?t.err(o):n?(s.comments=n,void e()):t.notfound("Post comments not found")})}),o.on("post",{action:"comment.create"},function(o){var n=new PostComment.model({state:"published",post:s.post.id,author:s.user.id});n.getUpdateHandler(e).process(e.body,{fields:"content",flashErrors:!0,logErrors:!0},function(r){if(!r)return e.flash("success","Your comment was added."),t.redirect("/blog/post/"+s.post.key+"#comment-id-"+n.id);validationErrors=r.errors,o()})}),o.on("get",{remove:"comment"},function(o){if(!e.user)return e.flash("error","You must be signed in to delete a comment."),o();PostComment.model.findOne({_id:e.query.comment,post:s.post.id}).exec(function(n,r){return n?"CastError"===n.name?(e.flash("error","The comment "+e.query.comment+" could not be found."),o()):t.err(n):r?r.author!=e.user.id?(e.flash("error","Sorry, you must be the author of a comment to delete it."),o()):(r.commentState="archived",void r.save(function(o){return o?t.err(o):(e.flash("success","Your comment has been deleted."),t.redirect("/blog/post/"+s.post.key))})):(e.flash("error","The comment "+e.query.comment+" could not be found."),o())})}),o.render("post")};